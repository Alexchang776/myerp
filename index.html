<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç å¯¶ ERP æ——è‰¦ç‰ˆ</title>
    
    <link rel="icon" href="https://drive.google.com/thumbnail?id=1T-Yb-Qq2LEbkzERCG62bLgiX6o8S3Fub&sz=w512" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://drive.google.com/thumbnail?id=1T-Yb-Qq2LEbkzERCG62bLgiX6o8S3Fub&sz=w512">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        
        :root { 
            --primary: #0f172a;       
            --accent: #d4af37;        
            --bg: #f8f9fa;            
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-sub: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --nav-height: 90px;       
            --header-height: 60px;
        }

        body { 
            margin: 0; background-color: var(--bg); color: var(--text-main);
            padding-bottom: calc(var(--nav-height) + 20px); padding-top: var(--header-height);              
        }

        /* --- ç™»å…¥é é¢ --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); padding: 40px 30px; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 100%; max-width: 350px; color: white;
        }
        .login-logo { width: 120px; height: 120px; border-radius: 24px; margin-bottom: 20px; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); }
        .login-title { font-size: 1.5rem; font-weight: 300; margin-bottom: 30px; letter-spacing: 2px; color: var(--accent); }
        .login-input { width: 100%; padding: 15px; margin-bottom: 20px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: white; font-size: 1.1rem; text-align: center; }
        .btn-login { width: 100%; padding: 15px; background: linear-gradient(135deg, #d4af37, #b49018); border: none; border-radius: 12px; color: #0f172a; font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4); }

        /* --- é ‚éƒ¨èˆ‡å°èˆª --- */
        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; font-weight: 800; color: var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); 
            background: var(--card-bg); display: flex; justify-content: space-around;
            border-top: 1px solid #e2e8f0; padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 900;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .nav-icon { font-size: 1.6rem; margin-bottom: 5px; opacity: 0.5; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .nav-icon { opacity: 1; transform: scale(1.2); }

        /* --- é€šç”¨ç‰ˆé¢ --- */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .section-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: var(--primary); border-left: 4px solid var(--accent); padding-left: 10px; display: flex; justify-content: space-between; align-items: center; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-sub); }
        input, select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #fff; appearance: none; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .btn { width: 100%; height: 55px; border-radius: 12px; border: none; font-weight: 700; font-size: 1.1rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }
        .btn-primary { background: linear-gradient(135deg, #0f172a, #334155); }
        .btn-action { background: linear-gradient(135deg, #d4af37, #b49018); color: #0f172a; }
        .btn-scan { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-danger { background: var(--danger); }
        .btn-sm { width: auto; height: 35px; font-size: 0.9rem; padding: 0 15px; margin: 0; }

        /* --- Dashboard Grid --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 0; }
        .dash-btn {
            width: 100%; aspect-ratio: 1 / 1; height: auto; border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); cursor: pointer;
            transition: transform 0.1s; position: relative; overflow: hidden;
        }
        .dash-btn:active { transform: scale(0.96); }
        .dash-icon { font-size: 4rem; margin-bottom: 10px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); }
        .dash-text { font-size: 1.3rem; font-weight: bold; letter-spacing: 1px; }

        .bg-buy { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .bg-sale { background: linear-gradient(135deg, #d4af37, #b49018); color:#fff; }
        .bg-stock { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-client { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-supplier { background: linear-gradient(135deg, #64748b, #475569); }

        /* --- åå–®åˆ—è¡¨ --- */
        .search-bar { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; font-size: 1rem; background: white url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="gray" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat 95% center; }
        .contact-list { max-height: 400px; overflow-y: auto; }
        .contact-item { padding: 15px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .contact-info b { display: block; font-size: 1.1rem; color: var(--primary); margin-bottom: 4px; }
        .contact-info span { font-size: 0.9rem; color: var(--text-sub); display: block; }
        .contact-amount { color: var(--success); font-weight: 800; font-size: 1.1rem; }

        /* --- å…¶ä»– --- */
        .img-preview-box { width: 100%; height: 220px; background: #f1f5f9; border-radius: 12px; border: 2px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; color: #94a3b8; overflow: hidden; margin-bottom: 15px; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; }
        #scan-container { position: relative; display: none; margin-bottom: 20px; border-radius: 12px; overflow: hidden; }
        #qr-canvas { width: 100%; }
        .list-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .list-thumb { width: 65px; height: 65px; border-radius: 10px; object-fit: cover; background: #eee; margin-right: 15px; border: 1px solid #e2e8f0; }
        .list-info { flex: 1; }
        .list-title { font-weight: 700; font-size: 1.05rem; color: var(--primary); margin-bottom: 4px; }
        .list-price { color: var(--success); font-weight: 800; font-size: 1.1rem; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; background: #e2e8f0; color: #64748b; }
        .tag-stock { background: #dcfce7; color: #166534; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body id="mainBody">

<div id="loading"><div class="spinner"></div><div style="margin-top:20px; font-weight:bold; color:var(--primary);">è™•ç†ä¸­...</div></div>

<div id="loginOverlay">
    <div class="login-card">
        <img src="https://drive.google.com/thumbnail?id=1T-Yb-Qq2LEbkzERCG62bLgiX6o8S3Fub&sz=w512" class="login-logo">
        <div class="login-title">JEWELRY ERP</div>
        <input type="text" id="acc" class="login-input" placeholder="ACCOUNT">
        <input type="password" id="pwd" class="login-input" placeholder="PASSWORD">
        <button class="btn-login" onclick="checkLogin()">ENTER SYSTEM</button>
    </div>
</div>

<div class="app-header">ç å¯¶é›²ç«¯ç³»çµ±</div>

<div id="content-area">

    <div id="page-dashboard" class="page active">
        <div class="dashboard-grid">
            <div class="dash-btn bg-buy" onclick="showPage('buy')">
                <div class="dash-icon">ğŸ“¥</div><div class="dash-text">é€²è²¨å–®</div>
            </div>
            <div class="dash-btn bg-sale" onclick="showPage('sale')">
                <div class="dash-icon">ğŸ’°</div><div class="dash-text">éŠ·è²¨å–®</div>
            </div>
            <div class="dash-btn bg-stock" onclick="showPage('stock')">
                <div class="dash-icon">ğŸ“¦</div><div class="dash-text">åº«å­˜è³‡æ–™</div>
            </div>
            <div class="dash-btn bg-client" onclick="openContactPage('Clients')">
                <div class="dash-icon">ğŸ‘¥</div><div class="dash-text">å®¢æˆ¶è³‡æ–™</div>
            </div>
            <div class="dash-btn bg-supplier" onclick="openContactPage('Suppliers')">
                <div class="dash-icon">ğŸ­</div><div class="dash-text">å» å•†è³‡æ–™</div>
            </div>
        </div>
    </div>

    <div id="page-sale" class="page">
        <div class="card">
            <div class="section-title">éŠ·è²¨çµå¸³</div>
            
            <div class="form-group">
                <label>äº¤æ˜“æ—¥æœŸ</label>
                <input type="date" id="saleDate">
            </div>

            <div class="form-group">
                <label>é¸æ“‡å•†å“</label>
                <select id="saleItem" onchange="updateSalePrice()"></select>
            </div>
            <div class="form-group">
                <label>é¸æ“‡å®¢æˆ¶</label>
                <select id="saleClient"></select>
            </div>
            
            <div class="form-group">
                <label>ä»˜æ¬¾æ–¹å¼</label>
                <select id="salePayment">
                    <option value="ç¾é‡‘">ç¾é‡‘</option>
                    <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
                    <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                    <option value="å°ç£Pay">å°ç£ Pay</option>
                    <option value="Line Pay">Line Pay</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>

            <div class="form-group">
                <label>å¯¦æ”¶é‡‘é¡</label>
                <input type="number" id="saleFinalPrice" style="color:var(--success); font-weight:bold; font-size:1.4rem;">
            </div>
            
            <button class="btn btn-action" onclick="doSale()">âœ… ç¢ºèªå”®å‡º</button>
        </div>
    </div>

    <div id="page-buy" class="page">
        <div class="card">
            <div class="section-title">å•†å“å…¥åº«</div>
            
            <div class="form-group">
                <label>é€²è²¨æ—¥æœŸ</label>
                <input type="date" id="buyDate">
            </div>

            <button class="btn btn-scan" onclick="startScan()">ğŸ“· æƒæé‘‘å®šæ›¸</button>
            <div id="scan-container">
                <canvas id="qr-canvas"></canvas>
                <button class="btn btn-danger" onclick="stopScan()">é—œé–‰ç›¸æ©Ÿ</button>
            </div>
            
            <div class="form-group"><label>ç·¨è™Ÿ (ID)</label><input type="text" id="buyId" readonly placeholder="æƒæå¾Œå¡«å…¥"></div>
            <div class="form-group"><label>åç¨±</label><input type="text" id="buyName"></div>
            <div class="form-group"><label>å» å•†</label><select id="buySupplier"></select></div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>æˆæœ¬</label><input type="number" id="buyCost"></div>
                <div style="flex:1"><label>å®šåƒ¹</label><input type="number" id="buyPrice"></div>
            </div>
            <label style="margin-top:15px;">å•†å“ç…§ç‰‡</label>
            <div class="img-preview-box" id="imgPreview" onclick="document.getElementById('cameraInput').click()">
                <div style="text-align:center;"><div style="font-size:2rem;">ğŸ“¸</div><div>é»æ“Šæ‹ç…§</div></div>
            </div>
            <input type="file" id="cameraInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
            <input type="hidden" id="buyImg"><input type="hidden" id="buyCertUrl">
            <button class="btn btn-primary" onclick="doBuy()">ğŸ’¾ å„²å­˜å…¥åº«</button>
        </div>
    </div>

    <div id="page-stock" class="page">
        <div class="card">
            <div class="section-title">åº«å­˜æ¸…å–®</div>
            <div id="stockList"></div>
        </div>
    </div>

    <div id="page-contacts" class="page">
        <div class="card">
            <div class="section-title">
                <span id="contactTitle">è³‡æ–™åˆ—è¡¨</span>
                <button class="btn btn-primary btn-sm" onclick="toggleContactMode()">â• æ–°å¢</button>
            </div>

            <div id="contactListArea">
                <input type="text" id="searchContact" class="search-bar" placeholder="ğŸ” æœå°‹åç¨±æˆ–é›»è©±..." oninput="renderContactList()">
                <div id="contactListView" class="contact-list"></div>
            </div>

            <div id="contactAddArea" style="display:none;">
                <div class="form-group" style="display:none;">
                    <label>é¡å‹</label>
                    <select id="contactType"><option value="Clients">å®¢æˆ¶</option><option value="Suppliers">å» å•†</option></select>
                </div>
                <div class="form-group"><label>ç·¨è™Ÿ</label><input type="text" id="contactId"></div>
                <div class="form-group"><label>åç¨±</label><input type="text" id="contactName"></div>
                <div class="form-group"><label>é›»è©±</label><input type="text" id="contactPhone"></div>
                <div class="form-group"><label>å‚™è¨»</label><input type="text" id="contactNote"></div>
                
                <button class="btn btn-primary" onclick="addContact()">ğŸ’¾ å„²å­˜è³‡æ–™</button>
                <button class="btn btn-danger" onclick="toggleContactMode()">â†© å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showPage('dashboard', this)"><div class="nav-icon">ğŸ </div><div>é¦–é </div></div>
    <div class="nav-item" onclick="showPage('buy', this)"><div class="nav-icon">ğŸ“¥</div><div>é€²è²¨</div></div>
    <div class="nav-item" onclick="showPage('sale', this)"><div class="nav-icon">ğŸ’°</div><div>éŠ·è²¨</div></div>
    <div class="nav-item" onclick="showPage('stock', this)"><div class="nav-icon">ğŸ“¦</div><div>åº«å­˜</div></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbymN7tFDVzZhi7HUanHBh9YKP07lgV1M4LrgNT7E5igPQU39KuGIIsxW-BWw4CMBPhcjA/exec";
    
    let inventory = [], clients = [], suppliers = [], currentUser = "";
    let video = document.createElement("video");
    let canvasElement = document.getElementById("qr-canvas");
    let canvas = canvasElement.getContext("2d");
    let scanning = false;

    // --- åˆå§‹åŒ– ---
    function initDateFields() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('saleDate').value = today;
        document.getElementById('buyDate').value = today;
    }

    // --- ç™»å…¥ ---
    async function checkLogin() {
        const acc = document.getElementById('acc').value;
        const pwd = document.getElementById('pwd').value;
        if(!acc || !pwd) { alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); return; }
        
        showLoading(true);
        try {
            const r = await fetch(`${API_URL}?type=login&acc=${acc}&pwd=${pwd}`);
            const res = await r.json();
            if(res.status === "success") {
                currentUser = res.name;
                document.getElementById('loginOverlay').style.opacity = '0';
                setTimeout(() => { document.getElementById('loginOverlay').style.display = 'none'; }, 500);
                syncAll();
                initDateFields();
            } else { alert("âŒ å¸³è™Ÿå¯†ç¢¼éŒ¯èª¤"); showLoading(false); }
        } catch(e) { alert("é€£ç·šå¤±æ•—"); showLoading(false); }
    }

    async function syncAll() {
        showLoading(true);
        try {
            const [stockRes, clientRes, suppRes] = await Promise.all([
                fetch(`${API_URL}?sheet=Stock`).then(r => r.json()),
                fetch(`${API_URL}?sheet=Clients`).then(r => r.json()),
                fetch(`${API_URL}?sheet=Suppliers`).then(r => r.json())
            ]);
            inventory = stockRes; clients = clientRes; suppliers = suppRes;
            renderAll();
        } catch(e) { console.error("Sync Error", e); }
        showLoading(false);
    }

    function renderAll() {
        const activeItems = inventory.filter(i => i[2] > 0);
        let saleOpts = '<option value="">è«‹é¸æ“‡å•†å“...</option>';
        activeItems.forEach(i => saleOpts += `<option value="${i[0]}">${i[1]} ($${i[4]})</option>`);
        document.getElementById('saleItem').innerHTML = saleOpts;

        let clientOpts = '<option value="">è«‹é¸æ“‡å®¢æˆ¶...</option>';
        clients.forEach(c => clientOpts += `<option value="${c[1]}">${c[1]}</option>`);
        document.getElementById('saleClient').innerHTML = clientOpts;

        let suppOpts = '<option value="">è«‹é¸æ“‡ä¾›æ‡‰å•†...</option>';
        suppliers.forEach(s => suppOpts += `<option value="${s[1]}">${s[1]}</option>`);
        document.getElementById('buySupplier').innerHTML = suppOpts;

        document.getElementById('stockList').innerHTML = inventory.map(i => `
            <div class="list-item">
                <img src="${i[6]}" class="list-thumb" onerror="this.src='https://via.placeholder.com/100?text=IMG'">
                <div class="list-info">
                    <div class="list-title">${i[1]}</div>
                    <div style="font-size:0.8rem; color:#666;">ID: ${i[0]}</div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span class="list-price">$${i[4]}</span>
                        <span class="tag ${i[2]>0 ? 'tag-stock':''}">${i[2]>0 ? 'åœ¨åº«':'å”®å‡º'}</span>
                    </div>
                </div>
                ${i[7] ? `<a href="${i[7]}" target="_blank" style="font-size:1.5rem; text-decoration:none; margin-left:10px;">ğŸ“œ</a>` : ''}
            </div>
        `).join('');
    }

    function updateSalePrice() {
        const id = document.getElementById('saleItem').value;
        const item = inventory.find(i => i[0] == id);
        if(item) document.getElementById('saleFinalPrice').value = item[4];
    }

    // --- åå–®é é¢é‚è¼¯ ---
    function openContactPage(type) {
        document.getElementById('contactType').value = type;
        const title = type === 'Clients' ? 'å®¢æˆ¶è³‡æ–™' : 'å» å•†è³‡æ–™';
        document.getElementById('contactTitle').innerText = title;
        
        // é‡ç½®ç‚ºåˆ—è¡¨æ¨¡å¼
        document.getElementById('contactListArea').style.display = 'block';
        document.getElementById('contactAddArea').style.display = 'none';
        document.getElementById('searchContact').value = "";
        
        renderContactList();
        showPage('contacts');
    }

    function toggleContactMode() {
        const listArea = document.getElementById('contactListArea');
        const addArea = document.getElementById('contactAddArea');
        if (listArea.style.display === 'none') {
            listArea.style.display = 'block';
            addArea.style.display = 'none';
        } else {
            listArea.style.display = 'none';
            addArea.style.display = 'block';
        }
    }

    function renderContactList() {
        const type = document.getElementById('contactType').value;
        const keyword = document.getElementById('searchContact').value.toLowerCase();
        const dataSource = type === 'Clients' ? clients : suppliers;
        const listContainer = document.getElementById('contactListView');
        
        let html = '';
        dataSource.forEach(item => {
            // [ID, Name, Phone, Note, Spend(Only Client)]
            const name = item[1].toString();
            const phone = item[2].toString();
            
            if (name.toLowerCase().includes(keyword) || phone.includes(keyword)) {
                let extraInfo = '';
                if (type === 'Clients') {
                    // é¡¯ç¤ºç´¯ç©æ¶ˆè²»
                    extraInfo = `<div class="contact-amount">ç´¯ç©: $${item[4] || 0}</div>`;
                }
                
                html += `
                    <div class="contact-item">
                        <div class="contact-info">
                            <b>${name}</b>
                            <span>${phone}</span>
                        </div>
                        ${extraInfo}
                    </div>
                `;
            }
        });
        listContainer.innerHTML = html || '<div style="padding:20px; text-align:center; color:#999;">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
    }

    // --- æ“ä½œ ---
    async function doBuy() {
        const id = document.getElementById('buyId').value;
        const name = document.getElementById('buyName').value;
        const date = document.getElementById('buyDate').value;
        
        if(!id || !name) { alert("è«‹è¼¸å…¥ ID èˆ‡ åç¨±"); return; }
        showLoading(true);
        const payload = { 
            action: "buy", id: id, name: name, date: date, // æ–°å¢æ—¥æœŸ
            cost: document.getElementById('buyCost').value, 
            price: document.getElementById('buyPrice').value, 
            supplier: document.getElementById('buySupplier').value, 
            img: document.getElementById('buyImg').value, 
            certUrl: document.getElementById('buyCertUrl').value 
        };
        const res = await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        const text = await res.text();
        if (text && text.includes("DUPLICATE")) alert("âŒ ID é‡è¤‡");
        else { 
            alert("âœ… å…¥åº«æˆåŠŸ");
            document.getElementById('buyId').value = ""; document.getElementById('buyName').value = "";
            document.getElementById('buyImg').value = ""; document.getElementById('imgPreview').innerHTML = `<div style="text-align:center;">ğŸ“¸ é»æ“Šæ‹ç…§</div>`;
        }
        showLoading(false); syncAll();
    }

    async function doSale() {
        const id = document.getElementById('saleItem').value;
        const date = document.getElementById('saleDate').value;
        const payment = document.getElementById('salePayment').value;
        
        if(!id) { alert("è«‹é¸æ“‡å•†å“"); return; }
        showLoading(true);
        const item = inventory.find(i => i[0] == id);
        
        await sendData({ 
            action: "sale", 
            id: item[0], name: item[1], 
            date: date, payment: payment, // æ–°å¢æ¬„ä½
            customer: document.getElementById('saleClient').value, 
            total: document.getElementById('saleFinalPrice').value, 
            user: currentUser 
        });
    }

    async function addContact() {
        if(!document.getElementById('contactName').value) { alert("è«‹è¼¸å…¥åç¨±"); return; }
        showLoading(true);
        await sendData({ action: "addContact", targetSheet: document.getElementById('contactType').value, id: document.getElementById('contactId').value, name: document.getElementById('contactName').value, phone: document.getElementById('contactPhone').value, note: document.getElementById('contactNote').value });
        toggleContactMode(); // å›åˆ°åˆ—è¡¨
    }

    // --- æƒæ/åœ–ç‰‡/å…±ç”¨å‡½æ•¸ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
    function startScan() {
        scanning = true; document.getElementById("scan-container").style.display = "block";
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s=>{ video.srcObject=s; video.setAttribute("playsinline",true); video.play(); requestAnimationFrame(tick); }).catch(e=>{alert("ç„¡ç›¸æ©Ÿæ¬Šé™");stopScan();});
    }
    function stopScan() { scanning=false; if(video.srcObject)video.srcObject.getTracks().forEach(t=>t.stop()); document.getElementById("scan-container").style.display="none"; }
    function tick() {
        if(!scanning)return; 
        if(video.readyState===video.HAVE_ENOUGH_DATA){
            canvasElement.height=video.videoHeight; canvasElement.width=video.videoWidth; 
            canvas.drawImage(video,0,0,canvasElement.width,canvasElement.height);
            var code=jsQR(canvas.getImageData(0,0,canvasElement.width,canvasElement.height).data,canvasElement.width,canvasElement.height,{inversionAttempts:"dontInvert"});
            if(code&&code.data){stopScan();handleCertScan(code.data);}
        }
        requestAnimationFrame(tick);
    }
    async function handleCertScan(url) {
        showLoading(true); document.getElementById('buyCertUrl').value=url;
        try{
            const res=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:"scanCertificate",url:url})});
            const r=await res.json();
            document.getElementById('buyId').value=r.id||(url.match(/ZSJ\d+/i)?url.match(/ZSJ\d+/i)[0]:"");
            if(r.extImg)await compressAndUpload(r.extImg,true); else document.getElementById('imgPreview').innerHTML='æ‰‹å‹•æ‹ç…§';
            if(r.id)alert("âœ… æƒææˆåŠŸ");else alert("âš ï¸ æ‰‹å‹•è¼¸å…¥ID");
        }catch(e){alert("è§£æå¤±æ•—");}showLoading(false);
    }
    async function compressAndUpload(src,isUrl=false){
        return new Promise(r=>{
            const i=new Image(); i.crossOrigin="Anonymous";
            i.onload=()=>{
                const c=document.createElement('canvas'),x=c.getContext('2d'),M=800;
                let w=i.width,h=i.height; if(w>h){if(w>M){h*=M/w;w=M}}else{if(h>M){w*=M/h;h=M}}
                c.width=w;c.height=h;x.drawImage(i,0,0,w,h);
                uploadToDrive(c.toDataURL('image/jpeg',0.7).split(',')[1],"img_"+Date.now()+".jpg").then(u=>{
                    document.getElementById('buyImg').value=u;
                    document.getElementById('imgPreview').innerHTML=`<img src="${u}" class="preview-img">`;r(u);
                });
            };i.onerror=()=>{document.getElementById('imgPreview').innerHTML='ç„¡æ³•æŠ“åœ–';r(null);};i.src=src;
        });
    }
    async function handleFileUpload(ip){if(!ip.files[0])return;showLoading(true);const rd=new FileReader();rd.onload=e=>{compressAndUpload(e.target.result);showLoading(false);};rd.readAsDataURL(ip.files[0]);}
    async function uploadToDrive(b64,fn){try{const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:"uploadImage",base64Data:b64,mimeType:"image/jpeg",fileName:fn})});return await r.text();}catch(e){return"";}}
    async function sendData(p){ await fetch(API_URL,{method:'POST',mode:'no-cors',body:JSON.stringify(p)}); alert("âœ… å®Œæˆ"); showLoading(false); syncAll(); }
    
    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const target = document.getElementById('page-' + id);
        if (target) target.classList.add('active');
        if (id === 'dashboard') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        else if (el) el.classList.add('active');
        window.scrollTo(0, 0);
    }
    function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
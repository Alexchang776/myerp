<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç å¯¶ ERP (é•·è¼©å‹å–„ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®šï¼šå¤§å­—é«”ã€é«˜å°æ¯” --- */
        :root { 
            --primary: #2563eb; /* ç§‘æŠ€è— */
            --primary-gradient: linear-gradient(135deg, #2563eb, #1d4ed8);
            --success: #059669; /* è­·çœ¼ç¶  */
            --danger: #dc2626; 
            --dark: #1e293b; 
            --bg: #f1f5f9; /* æ·ºç°èƒŒæ™¯è­·çœ¼ */
            --card-bg: #ffffff;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            padding-bottom: 100px; /* é¿é–‹ä¸‹æ–¹å°èˆª */
            font-size: 18px; /* åŸºç¤å­—é«”åŠ å¤§ */
            color: #333;
        }

        /* --- æ¨™é¡Œåˆ— --- */
        .header { 
            background: var(--dark); 
            color: white; 
            padding: 25px 20px; 
            text-align: center; 
            font-size: 1.4rem; 
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky; 
            top: 0; 
            z-index: 100;
        }

        /* --- åˆ†é åˆ‡æ›æ•ˆæœ --- */
        .page { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- å¡ç‰‡å¼è¨­è¨ˆ --- */
        .card { 
            background: var(--card-bg); 
            border-radius: 20px; /* åœ“è§’æ›´æŸ”å’Œ */
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            border: 1px solid #e2e8f0;
        }

        h3 { 
            margin-top: 0; 
            color: var(--primary); 
            font-size: 1.3rem; 
            border-bottom: 2px solid #e2e8f0; 
            padding-bottom: 10px; 
            margin-bottom: 20px;
        }

        /* --- è¼¸å…¥æ¡†èˆ‡æ¨™ç±¤å„ªåŒ– --- */
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            font-size: 1.1rem; /* æ¨™ç±¤å­—é«”åŠ å¤§ */
            color: #475569; 
        }
        
        input, select { 
            width: 100%; 
            padding: 15px; /* å¢åŠ é»æ“Šå€åŸŸ */
            margin-bottom: 20px; 
            border: 2px solid #cbd5e1; 
            border-radius: 12px; 
            font-size: 1.1rem; /* è¼¸å…¥å­—é«”åŠ å¤§ */
            background-color: #fff;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        /* --- æŒ‰éˆ•å„ªåŒ– (å¤§æŒ‰éˆ•ã€æ¼¸å±¤) --- */
        .btn { 
            width: 100%; 
            padding: 18px; /* åŠ é«˜æŒ‰éˆ• */
            border-radius: 15px; 
            border: none; 
            font-weight: bold; 
            font-size: 1.2rem; /* æŒ‰éˆ•å­—é«”åŠ å¤§ */
            color: white; 
            cursor: pointer; 
            margin-bottom: 15px; 
            transition: transform 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-gradient); }
        .btn-success { background: linear-gradient(135deg, #059669, #10b981); }
        .btn-camera { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .btn-danger { background: var(--danger); }
        .btn-dark { background: #475569; }

        /* --- ä¸‹æ–¹å°èˆªåˆ— --- */
        .nav-bar { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: white; 
            display: flex; 
            border-top: 1px solid #e2e8f0; 
            height: 85px; /* åŠ é«˜å°èˆªåˆ— */
            z-index: 100; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .nav-item { 
            flex: 1; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            font-size: 1rem; 
            color: #94a3b8; 
            cursor: pointer;
        }
        
        .nav-item.active { 
            color: var(--primary); 
            font-weight: bold; 
            background-color: #eff6ff;
        }
        
        .nav-icon { font-size: 1.8rem; margin-bottom: 4px; } /* åœ–ç¤ºåŠ å¤§ */

        /* --- æƒæèˆ‡åœ–ç‰‡ --- */
        #scan-container { position: relative; display: none; margin-bottom: 20px; border: 4px solid var(--primary); border-radius: 12px; overflow: hidden; }
        #qr-canvas { width: 100%; background: #000; }
        #scan-status { position: absolute; top: 15px; left: 0; width: 100%; text-align: center; color: white; font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 4px black; }
        
        .preview-img { width: 100%; border-radius: 12px; margin: 15px 0; border: 2px solid #e2e8f0; max-height: 350px; object-fit: contain; background: white; }
        
        /* --- åˆ—è¡¨æ¨£å¼ --- */
        .list-row { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 15px 0; 
            border-bottom: 1px solid #f1f5f9; 
        }
        .stock-img { 
            width: 70px; height: 70px; /* åˆ—è¡¨åœ–ç‰‡åŠ å¤§ */
            object-fit: cover; 
            border-radius: 10px; 
            background: #eee; 
            border: 1px solid #ddd;
        }
        
        /* --- è¼‰å…¥é®ç½© --- */
        #loading { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: none; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            color: white; 
            font-size: 1.5rem;
        }
        
        /* --- ç™»å…¥ç•«é¢ --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc;
            z-index: 1500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 30px;
            box-sizing: border-box;
        }
    </style>
</head>
<body id="mainBody">

<div id="loading">
    <div style="font-size: 4rem;">â³</div>
    <div id="loadingText" style="margin-top:20px;">è™•ç†ä¸­...</div>
</div>

<div id="loginOverlay">
    <h2 style="text-align:center; color: var(--dark); font-size: 2rem; margin-bottom: 40px;">ğŸ’ ç å¯¶ç®¡ç†ç³»çµ±</h2>
    <label>å¸³è™Ÿ</label>
    <input type="text" id="acc" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
    <label>å¯†ç¢¼</label>
    <input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="btn btn-dark" onclick="checkLogin()">ç™»å…¥ç³»çµ±</button>
</div>

<div class="header">ç å¯¶é›²ç«¯ ERP</div>

<div id="page-sale" class="page active">
    <div class="card">
        <h3>ğŸ’° éŠ·è²¨çµå¸³ (è³£æ±è¥¿)</h3>
        <label>1. é¸æ“‡å•†å“</label>
        <select id="saleItem" onchange="updateSalePrice()"></select>
        
        <label>2. é¸æ“‡å®¢æˆ¶</label>
        <select id="saleClient"></select>
        
        <label>3. ç¢ºèªé‡‘é¡</label>
        <input type="number" id="saleFinalPrice" style="font-size: 1.5rem; font-weight: bold; color: var(--success);">
        
        <button class="btn btn-primary" onclick="doSale()">âœ… ç¢ºèªå”®å‡º</button>
    </div>
</div>

<div id="page-buy" class="page">
    <div class="card">
        <h3>ğŸ“¥ å•†å“é€²è²¨ (è²·æ±è¥¿)</h3>
        
        <button class="btn btn-camera" onclick="startScan()">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ QR Code</button>
        
        <div id="scan-container">
            <canvas id="qr-canvas"></canvas>
            <div id="scan-status">æº–å‚™ä¸­...</div>
            <button class="btn btn-danger" style="border-radius:0;" onclick="stopScan()">âŒ é—œé–‰ç›¸æ©Ÿ</button>
        </div>
        
        <label>å•†å“ç·¨è™Ÿ (ID)</label>
        <input type="text" id="buyId" placeholder="æƒæå¾Œè‡ªå‹•å¡«å…¥" style="background-color: #f1f5f9;">
        
        <label>å•†å“åç¨±</label>
        <input type="text" id="buyName" placeholder="ä¾‹å¦‚ï¼šç¿¡ç¿ æ‰‹é²">
        
        <label>ä¾›æ‡‰å•† (èª°è³£çš„)</label>
        <select id="buySupplier"></select>
        
        <div style="display:flex; gap:15px">
            <div style="flex:1"><label>é€²è²¨æˆæœ¬</label><input type="number" id="buyCost"></div>
            <div style="flex:1"><label>é å®šå”®åƒ¹</label><input type="number" id="buyPrice"></div>
        </div>
        
        <label>å•†å“ç…§ç‰‡ (æœƒè‡ªå‹•å£“ç¸®)</label>
        <div id="imgPreview" style="text-align: center; padding: 20px; border: 2px dashed #cbd5e1; border-radius: 12px; margin-bottom: 20px; color: #94a3b8;">
            (å°šæœªæœ‰åœ–ç‰‡)
        </div>
        
        <button class="btn btn-dark" onclick="document.getElementById('cameraInput').click()">ğŸ“¸ æ‰‹å‹•æ‹ç…§ / ä¸Šå‚³</button>
        <input type="file" id="cameraInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
        
        <input type="hidden" id="buyImg">
        <input type="hidden" id="buyCertUrl">
        
        <div style="height: 20px;"></div>
        <button class="btn btn-success" onclick="doBuy()">ğŸ’¾ ç¢ºèªå…¥åº«å­˜</button>
    </div>
</div>

<div id="page-stock" class="page">
    <div class="card">
        <h3>ğŸ“¦ åº«å­˜æ¸…å–® (å€‰åº«)</h3>
        <div id="stockList"></div>
    </div>
</div>

<div id="page-contacts" class="page">
    <div class="card">
        <h3>ğŸ‘¥ æ–°å¢åå–®</h3>
        <label>é¡å‹</label>
        <select id="contactType">
            <option value="Clients">å®¢æˆ¶ (è²·å®¶)</option>
            <option value="Suppliers">ä¾›æ‡‰å•† (è³£å®¶)</option>
        </select>
        
        <label>ç·¨è™Ÿ</label><input type="text" id="contactId">
        <label>åç¨±</label><input type="text" id="contactName">
        <label>é›»è©±</label><input type="text" id="contactPhone">
        <label>å‚™è¨»</label><input type="text" id="contactNote">
        
        <button class="btn btn-dark" onclick="addContact()">â• æ–°å¢è³‡æ–™</button>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showPage('sale', this)">
        <span class="nav-icon">ğŸ’°</span>
        <span>éŠ·è²¨</span>
    </div>
    <div class="nav-item" onclick="showPage('buy', this)">
        <span class="nav-icon">ğŸ“¥</span>
        <span>é€²è²¨</span>
    </div>
    <div class="nav-item" onclick="showPage('stock', this)">
        <span class="nav-icon">ğŸ“¦</span>
        <span>åº«å­˜</span>
    </div>
    <div class="nav-item" onclick="showPage('contacts', this)">
        <span class="nav-icon">ğŸ‘¥</span>
        <span>åå–®</span>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbymN7tFDVzZhi7HUanHBh9YKP07lgV1M4LrgNT7E5igPQU39KuGIIsxW-BWw4CMBPhcjA/exec"; // <--- è«‹è¨˜å¾—æ›é€™è£¡
    let inventory = [], clients = [], suppliers = [], currentUser = "";
    let video = document.createElement("video");
    let canvasElement = document.getElementById("qr-canvas");
    let canvas = canvasElement.getContext("2d");
    let scanning = false;

    // --- ç™»å…¥èˆ‡åŒæ­¥ ---
    async function checkLogin() {
        const acc = document.getElementById('acc').value;
        const pwd = document.getElementById('pwd').value;
        if(!acc || !pwd) { alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); return; }
        
        showLoading(true, "ç™»å…¥ç³»çµ±ä¸­...");
        try {
            const r = await fetch(`${API_URL}?type=login&acc=${acc}&pwd=${pwd}`);
            const res = await r.json();
            if(res.status === "success") {
                currentUser = res.name;
                document.getElementById('loginOverlay').style.display = 'none';
                syncAll();
            } else { alert("âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
        } catch(e) { alert("ç„¡æ³•é€£ç·šï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); }
        showLoading(false);
    }

    async function syncAll() {
        showLoading(true, "æ›´æ–°è³‡æ–™ä¸­...");
        try {
            const [stockRes, clientRes, suppRes] = await Promise.all([
                fetch(`${API_URL}?sheet=Stock`).then(r => r.json()),
                fetch(`${API_URL}?sheet=Clients`).then(r => r.json()),
                fetch(`${API_URL}?sheet=Suppliers`).then(r => r.json())
            ]);
            inventory = stockRes; clients = clientRes; suppliers = suppRes;
            renderAll();
        } catch(e) { console.error("åŒæ­¥å¤±æ•—"); }
        showLoading(false);
    }

    function renderAll() {
        // æ¸²æŸ“ä¸‹æ‹‰é¸å–®èˆ‡åˆ—è¡¨ (éæ¿¾åº«å­˜>0)
        const activeItems = inventory.filter(i => i[2] > 0);
        
        let saleOptions = '<option value="">è«‹é¸æ“‡å•†å“...</option>';
        activeItems.forEach(i => {
            saleOptions += `<option value="${i[0]}">${i[1]} ($${i[4]})</option>`;
        });
        document.getElementById('saleItem').innerHTML = saleOptions;

        let clientOptions = '<option value="">è«‹é¸æ“‡å®¢æˆ¶...</option>';
        clients.forEach(c => { clientOptions += `<option value="${c[1]}">${c[1]}</option>`; });
        document.getElementById('saleClient').innerHTML = clientOptions;

        let suppOptions = '<option value="">è«‹é¸æ“‡ä¾›æ‡‰å•†...</option>';
        suppliers.forEach(s => { suppOptions += `<option value="${s[1]}">${s[1]}</option>`; });
        document.getElementById('buySupplier').innerHTML = suppOptions;

        document.getElementById('stockList').innerHTML = inventory.map(i => `
            <div class="list-row" style="opacity: ${i[2] <= 0 ? 0.5 : 1}">
                <img src="${i[6] || ''}" class="stock-img" onerror="this.src='https://via.placeholder.com/100?text=ç„¡åœ–'">
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:1.2rem; color:var(--dark)">${i[1]}</div>
                    <div style="color:#64748b; margin-top:5px;">ID: ${i[0]}</div>
                    <div style="color:var(--success); font-weight:bold; font-size:1.1rem; margin-top:5px;">$${i[4]}</div>
                </div>
                <div>${i[7] ? `<a href="${i[7]}" target="_blank" style="font-size:2rem; text-decoration:none;">ğŸ“œ</a>` : ''}</div>
                <div style="font-weight:bold; margin-left:10px;">${i[2] > 0 ? 'åœ¨åº«' : 'å”®å‡º'}</div>
            </div>
        `).join('');
        
        updateSalePrice();
    }

    function updateSalePrice() {
        const id = document.getElementById('saleItem').value;
        const item = inventory.find(i => i[0] == id);
        if(item) document.getElementById('saleFinalPrice').value = item[4];
        else document.getElementById('saleFinalPrice').value = "";
    }

    // --- æƒæåŠŸèƒ½ (ç´…æ¡†ç‰ˆ) ---
    function startScan() {
        scanning = true;
        document.getElementById("scan-container").style.display = "block";
        document.getElementById("scan-status").innerText = "ğŸ“· ç›¸æ©Ÿå•Ÿå‹•ä¸­...";
        
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            requestAnimationFrame(tick);
        }).catch(function(err){
            alert("âŒ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨ç›¸æ©Ÿæ¬Šé™");
            stopScan();
        });
    }

    function stopScan() {
        scanning = false;
        if(video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
        document.getElementById("scan-container").style.display = "none";
    }

    function tick() {
        if (!scanning) return;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            document.getElementById("scan-status").innerText = "ğŸ” è«‹å°æº– QR Code";
            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            
            var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code && code.data) {
                // ç•«ç´…æ¡†
                drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF0000");
                drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF0000");
                drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF0000");
                drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF0000");
                
                // ç¨å¾®å»¶é²ä¸€ä¸‹è®“ä½¿ç”¨è€…çœ‹åˆ°æ¡†
                setTimeout(() => {
                    stopScan();
                    handleCertScan(code.data);
                }, 300);
                return;
            }
        }
        requestAnimationFrame(tick);
    }

    function drawLine(begin, end, color) {
        canvas.beginPath();
        canvas.moveTo(begin.x, begin.y);
        canvas.lineTo(end.x, end.y);
        canvas.lineWidth = 5;
        canvas.strokeStyle = color;
        canvas.stroke();
    }

    // --- æƒæå¾Œè™•ç† ---
    async function handleCertScan(url) {
        showLoading(true, "æ­£åœ¨è§£æè­‰æ›¸...");
        document.getElementById('buyCertUrl').value = url;
        
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "scanCertificate", url: url }) });
            const result = await res.json();
            
            let finalId = result.id;
            if(!finalId) {
                // è£œæ•‘ï¼šå¾ç¶²å€æŠ“ ID
                let match = url.match(/ZSJ\d+/i);
                if(match) finalId = match[0];
            }

            document.getElementById('buyId').value = finalId;

            // è™•ç†åœ–ç‰‡ (è‡ªå‹•è½‰å­˜)
            if (result.extImg) {
               showLoading(true, "ä¸‹è¼‰ä¸¦å£“ç¸®åœ–ç‰‡...");
               await compressAndUpload(result.extImg, true); 
            } else {
               document.getElementById('imgPreview').innerHTML = "<p style='color:red; font-size:1.2rem;'>âŒ æŠ“ä¸åˆ°åœ–ç‰‡ï¼Œè«‹æ‰‹å‹•æ‹ç…§</p>";
               document.getElementById('buyImg').value = "";
            }

            if(finalId) {
                alert("âœ… æƒææˆåŠŸï¼ID å·²å¡«å…¥");
            } else {
                alert("âš ï¸ å·²æŠ“åˆ°ç¶²å€ï¼Œä½†æ‰¾ä¸åˆ° IDï¼Œè«‹æ‰‹å‹•è¼¸å…¥");
            }

        } catch(e) {
            alert("ä¼ºæœå™¨å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
        showLoading(false);
    }

    // --- åœ–ç‰‡è™•ç† ---
    async function compressAndUpload(source, isUrl = false) {
        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_SIZE = 800;
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                } else {
                    if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                
                uploadToDrive(base64Data, "img_" + Date.now() + ".jpg").then(url => {
                    document.getElementById('buyImg').value = url;
                    document.getElementById('imgPreview').innerHTML = `<img src="${url}" class="preview-img">`;
                    resolve(url);
                });
            };
            img.onerror = function() {
                document.getElementById('imgPreview').innerHTML = "<p style='color:red;'>åœ–ç‰‡ä¸‹è¼‰å¤±æ•— (é˜²ç›œé€£)ï¼Œè«‹æ‰‹å‹•æ‹ç…§</p>";
                resolve(null);
            };
            img.src = source;
        });
    }

    async function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        showLoading(true, "åœ–ç‰‡å£“ç¸®ä¸Šå‚³ä¸­...");
        const reader = new FileReader();
        reader.onload = function(e) { compressAndUpload(e.target.result); showLoading(false); };
        reader.readAsDataURL(file);
    }

    async function uploadToDrive(base64, filename) {
        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: "uploadImage", base64Data: base64, mimeType: "image/jpeg", fileName: filename }) 
            });
            return await res.text();
        } catch(e) { return ""; }
    }

    // --- é€²éŠ·å­˜æ“ä½œ ---
    async function doBuy() {
        const id = document.getElementById('buyId').value;
        const name = document.getElementById('buyName').value;
        if(!id || !name) { alert("âš ï¸ è«‹è¼¸å…¥ã€Œå•†å“ IDã€å’Œã€Œå•†å“åç¨±ã€"); return; }
        
        showLoading(true, "æ­£åœ¨å¯«å…¥è³‡æ–™åº«...");
        const payload = { 
            action: "buy", 
            id: id, 
            name: name, 
            cost: document.getElementById('buyCost').value, 
            price: document.getElementById('buyPrice').value, 
            supplier: document.getElementById('buySupplier').value, 
            img: document.getElementById('buyImg').value,
            certUrl: document.getElementById('buyCertUrl').value 
        };
        
        const res = await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        const text = await res.text();
        
        if (text && text.includes("DUPLICATE")) {
            alert("âŒ éŒ¯èª¤ï¼šé€™å€‹ ID å·²ç¶“åœ¨å€‰åº«è£¡äº†ï¼");
        } else {
            alert("âœ… å…¥åº«æˆåŠŸï¼");
            document.getElementById('buyId').value = "";
            document.getElementById('buyName').value = "";
            document.getElementById('buyImg').value = "";
            document.getElementById('imgPreview').innerHTML = "(å°šæœªæœ‰åœ–ç‰‡)";
        }
        
        showLoading(false);
        syncAll();
    }

    async function doSale() {
        const id = document.getElementById('saleItem').value;
        if(!id) { alert("è«‹é¸æ“‡å•†å“"); return; }
        
        showLoading(true, "çµå¸³ä¸­...");
        const item = inventory.find(i => i[0] == id);
        await sendData({ 
            action: "sale", 
            id: item[0], 
            name: item[1], 
            customer: document.getElementById('saleClient').value, 
            total: document.getElementById('saleFinalPrice').value, 
            user: currentUser 
        });
    }

    async function addContact() {
        const name = document.getElementById('contactName').value;
        if(!name) { alert("è«‹è¼¸å…¥åç¨±"); return; }
        showLoading(true, "æ–°å¢ä¸­...");
        await sendData({ 
            action: "addContact", 
            targetSheet: document.getElementById('contactType').value, 
            id: document.getElementById('contactId').value, 
            name: name, 
            phone: document.getElementById('contactPhone').value, 
            note: document.getElementById('contactNote').value 
        });
    }

    async function sendData(p) {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
        alert("âœ… æ“ä½œå®Œæˆï¼");
        showLoading(false);
        syncAll();
    }

    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function showLoading(s, text="è™•ç†ä¸­...") { 
        document.getElementById('loading').style.display = s ? 'flex' : 'none'; 
        document.getElementById('loadingText').innerText = text;
    }
</script>
</body>
</html>
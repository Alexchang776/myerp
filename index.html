<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç å¯¶ ERP æ——è‰¦ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #2c3e50; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        .header { background: var(--dark); color: white; padding: 20px 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 10px; font-size: 1.1rem; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; color: #555; }
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; color: white; cursor: pointer; margin-bottom: 10px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; height: 65px; z-index: 100; }
        .nav-item { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; font-size: 0.75rem; color: #888; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        #scan-container { position: relative; display: none; margin-bottom: 15px; }
        #qr-canvas { width: 100%; border-radius: 8px; background: #000; }
        #scan-status { position: absolute; top: 10px; left: 0; width: 100%; text-align: center; color: white; text-shadow: 1px 1px 2px black; font-weight: bold; pointer-events: none; }
        
        .preview-img { width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #eee; max-height: 250px; object-fit: contain; }
        .stock-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .list-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .is-staff .admin-only { display: none !important; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; color: white; }
    </style>
</head>
<body id="mainBody">

<div id="loading">
    <div style="font-size: 2rem;">â³</div>
    <div id="loadingText">è™•ç†ä¸­...</div>
</div>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1000; display:flex; flex-direction:column; justify-content:center; padding:30px; box-sizing:border-box;">
    <h2 style="text-align:center;">ğŸ’ ç å¯¶ç³»çµ±ç™»å…¥</h2>
    <input type="text" id="acc" placeholder="å¸³è™Ÿ">
    <input type="password" id="pwd" placeholder="å¯†ç¢¼">
    <button class="btn" style="background:var(--dark)" onclick="checkLogin()">ç™»å…¥</button>
</div>

<div class="header"><strong>ç å¯¶é›²ç«¯ç®¡ç†</strong></div>

<div id="page-sale" class="page active">
    <div class="card">
        <h3>ğŸ’° éŠ·è²¨çµå¸³</h3>
        <label>é¸æ“‡å•†å“ (ID)</label><select id="saleItem" onchange="updateSalePrice()"></select>
        <label>å®¢æˆ¶</label><select id="saleClient"></select>
        <label>æˆäº¤é‡‘é¡</label><input type="number" id="saleFinalPrice">
        <button class="btn" style="background:var(--primary)" onclick="doSale()">ç¢ºèªéŠ·å‡º</button>
    </div>
</div>

<div id="page-buy" class="page">
    <div class="card">
        <h3>ğŸ“¥ å•†å“é€²è²¨</h3>
        
        <button class="btn" style="background:#6f42c1;" onclick="startScan()">ğŸ” é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
        
        <div id="scan-container">
            <canvas id="qr-canvas"></canvas>
            <div id="scan-status">ğŸ“· å•Ÿå‹•ä¸­...</div>
            <button class="btn" style="background:#dc3545; margin-top:5px;" onclick="stopScan()">âŒ é—œé–‰ç›¸æ©Ÿ</button>
        </div>
        
        <label>å•†å“ ID (æª¢æ¸¬ç·¨è™Ÿ)</label><input type="text" id="buyId" style="background-color: #e9ecef;" readonly>
        <label>å•†å“åç¨±</label><input type="text" id="buyName" placeholder="æ‰‹å‹•è¼¸å…¥åç¨±">
        <label>ä¾›æ‡‰å•†</label><select id="buySupplier"></select>
        
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>æˆæœ¬</label><input type="number" id="buyCost"></div>
            <div style="flex:1"><label>å”®åƒ¹</label><input type="number" id="buyPrice"></div>
        </div>
        
        <label>å•†å“åœ–ç‰‡ (è‡ªå‹•å£“ç¸®å„²å­˜)</label>
        <div id="imgPreview" style="text-align: center; color: #888; margin-bottom: 10px;">(å°šæœªæœ‰åœ–ç‰‡)</div>
        <button class="btn" style="background:#6c757d;" onclick="document.getElementById('cameraInput').click()">ğŸ“· æ‰‹å‹•æ‹ç…§/ä¸Šå‚³</button>
        <input type="file" id="cameraInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
        
        <input type="hidden" id="buyImg"> <input type="hidden" id="buyCertUrl">
        
        <button class="btn" style="background:var(--success)" onclick="doBuy()">å®Œæˆå…¥åº«</button>
    </div>
</div>

<div id="page-stock" class="page">
    <div class="card">
        <h3>ğŸ“¦ åœ¨åº«æ¸…å–®</h3>
        <div id="stockList"></div>
    </div>
</div>

<div id="page-contacts" class="page">
    <div class="card">
        <h3>ğŸ‘¥ åå–®ç®¡ç†</h3>
        <select id="contactType"><option value="Clients">å®¢æˆ¶</option><option value="Suppliers">å» å•†</option></select>
        <input type="text" id="contactId" placeholder="ç·¨è™Ÿ">
        <input type="text" id="contactName" placeholder="åç¨±">
        <input type="text" id="contactPhone" placeholder="é›»è©±">
        <input type="text" id="contactNote" placeholder="å‚™è¨»">
        <button class="btn" style="background:var(--dark)" onclick="addContact()">æ–°å¢åå–®</button>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showPage('sale', this)">ğŸ’°éŠ·è²¨</div>
    <div class="nav-item admin-only" id="nav-buy" onclick="showPage('buy', this)">ğŸ“¥é€²è²¨</div>
    <div class="nav-item" onclick="showPage('stock', this)">ğŸ“¦åº«å­˜</div>
    <div class="nav-item" onclick="showPage('contacts', this)">ğŸ‘¥åå–®</div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbymN7tFDVzZhi7HUanHBh9YKP07lgV1M4LrgNT7E5igPQU39KuGIIsxW-BWw4CMBPhcjA/exec"; 
    let inventory = [], clients = [], suppliers = [], currentUser = "", userRole = "";
    let video = document.createElement("video");
    let canvasElement = document.getElementById("qr-canvas");
    let canvas = canvasElement.getContext("2d");
    let scanning = false;

    async function checkLogin() {
        const acc = document.getElementById('acc').value;
        const pwd = document.getElementById('pwd').value;
        showLoading(true, "ç™»å…¥ä¸­...");
        try {
            const r = await fetch(`${API_URL}?type=login&acc=${acc}&pwd=${pwd}`);
            const res = await r.json();
            if(res.status === "success") {
                currentUser = res.name; userRole = res.role;
                if(userRole === "staff") document.getElementById('mainBody').classList.add('is-staff');
                document.getElementById('loginOverlay').style.display = 'none';
                syncAll();
            } else { alert("å¸³å¯†éŒ¯èª¤"); }
        } catch(e) { alert("é€£ç·šå¤±æ•—"); }
        showLoading(false);
    }

    async function syncAll() {
        showLoading(true, "åŒæ­¥è³‡æ–™...");
        try {
            const [stockRes, clientRes, suppRes] = await Promise.all([
                fetch(`${API_URL}?sheet=Stock`).then(r => r.json()),
                fetch(`${API_URL}?sheet=Clients`).then(r => r.json()),
                fetch(`${API_URL}?sheet=Suppliers`).then(r => r.json())
            ]);
            inventory = stockRes; clients = clientRes; suppliers = suppRes;
            renderAll();
        } catch(e) { console.error("åŒæ­¥å¤±æ•—"); }
        showLoading(false);
    }

    function renderAll() {
        const activeItems = inventory.filter(i => i[2] > 0);
        document.getElementById('saleItem').innerHTML = activeItems.map(i => `<option value="${i[0]}">${i[1]} (${i[0]})</option>`).join('');
        document.getElementById('saleClient').innerHTML = clients.map(c => `<option value="${c[1]}">${c[1]}</option>`).join('');
        document.getElementById('buySupplier').innerHTML = suppliers.map(s => `<option value="${s[1]}">${s[1]}</option>`).join('');
        updateSalePrice();
        
        document.getElementById('stockList').innerHTML = inventory.map(i => `
            <div class="list-row" style="opacity: ${i[2] <= 0 ? 0.4 : 1}">
                <img src="${i[6] || ''}" class="stock-img" onerror="this.src='https://via.placeholder.com/50?text=NoImg'">
                <div style="flex:1"><b>${i[1]}</b> <small class="admin-only">($${i[3]})</small><br><span style="color:var(--success); font-weight:bold;">$${i[4]}</span> | ID: ${i[0]}</div>
                <div>${i[7] ? `<a href="${i[7]}" target="_blank">ğŸ“œ</a>` : ''}</div>
                <b>${i[2] > 0 ? 'åœ¨åº«' : 'å”®å‡º'}</b>
            </div>
        `).join('');
    }

    function updateSalePrice() {
        const item = inventory.find(i => i[0] == document.getElementById('saleItem').value);
        if(item) document.getElementById('saleFinalPrice').value = item[4];
    }

    // --- æƒæåŠŸèƒ½ ---
    function startScan() {
        scanning = true;
        document.getElementById("scan-container").style.display = "block";
        document.getElementById("scan-status").innerText = "ğŸ“· æ­£åœ¨é–‹å•Ÿç›¸æ©Ÿ...";
        
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            requestAnimationFrame(tick);
        }).catch(function(err){
            alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ");
            stopScan();
        });
    }

    function stopScan() {
        scanning = false;
        if(video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
        document.getElementById("scan-container").style.display = "none";
    }

    function tick() {
        if (!scanning) return;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            document.getElementById("scan-status").innerText = "ğŸ” æœå°‹ QR Code ä¸­...";
            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code) {
                if(code.data) {
                    stopScan();
                    handleCertScan(code.data);
                    return;
                }
            }
        }
        requestAnimationFrame(tick);
    }

    async function handleCertScan(url) {
        showLoading(true, "è§£æ QR Code...");
        document.getElementById('buyCertUrl').value = url;
        
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "scanCertificate", url: url }) });
            const result = await res.json();
            
            let finalId = result.id;
            if(!finalId) {
                let match = url.match(/ZSJ\d+/i);
                if(match) finalId = match[0];
            }

            document.getElementById('buyId').value = finalId;

            // å˜—è©¦è‡ªå‹•æŠ“å–åœ–ç‰‡ä¸¦ä¸Šå‚³åˆ° Drive
            if (result.extImg) {
               showLoading(true, "ä¸‹è¼‰ä¸¦å£“ç¸®åœ–ç‰‡...");
               await compressAndUpload(result.extImg, true); // true ä»£è¡¨é€™æ˜¯ URL
            } else {
               document.getElementById('imgPreview').innerHTML = "<p style='color:red;'>ç„¡æ³•è‡ªå‹•æŠ“åœ–ï¼Œè«‹æ‰‹å‹•æ‹ç…§</p>";
               document.getElementById('buyImg').value = "";
            }

            if(finalId) {
                alert("âœ… æƒææˆåŠŸï¼");
            } else {
                alert("âš ï¸ è«‹æ‰‹å‹•è¼¸å…¥å•†å“ ID");
            }

        } catch(e) {
            alert("ä¼ºæœå™¨é€£ç·šç•°å¸¸");
        }
        showLoading(false);
    }

    // --- åœ–ç‰‡å£“ç¸®èˆ‡ä¸Šå‚³æ ¸å¿ƒ ---
    async function compressAndUpload(source, isUrl = false) {
        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // å˜—è©¦è™•ç†è·¨åŸŸ
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // å›ºå®šå°ºå¯¸ï¼šæœ€é•·é‚Š 800px
                const MAX_SIZE = 800;
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                } else {
                    if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                // è½‰æˆ base64 (å“è³ª 0.7)
                const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                
                // ä¸Šå‚³åˆ° GAS
                uploadToDrive(base64Data, "product_" + Date.now() + ".jpg").then(url => {
                    document.getElementById('buyImg').value = url;
                    document.getElementById('imgPreview').innerHTML = `<img src="${url}" class="preview-img">`;
                    resolve(url);
                });
            };
            
            img.onerror = function() {
                document.getElementById('imgPreview').innerHTML = "<p style='color:red;'>åœ–ç‰‡ä¸‹è¼‰å¤±æ•— (é˜²ç›œé€£)ï¼Œè«‹æ‰‹å‹•æ‹ç…§</p>";
                resolve(null);
            };

            if(isUrl) {
                img.src = source; // é€™è£¡å¯èƒ½æœƒè¢« CORS æ“‹ï¼Œè‹¥æ“‹ä½æœƒè§¸ç™¼ onerror -> ä½¿ç”¨è€…æ‰‹å‹•æ‹ç…§
            } else {
                img.src = source;
            }
        });
    }

    async function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        showLoading(true, "å£“ç¸®åœ–ç‰‡ä¸­...");
        
        const reader = new FileReader();
        reader.onload = function(e) {
            compressAndUpload(e.target.result); // å£“ç¸®ä¸¦ä¸Šå‚³
            showLoading(false);
        };
        reader.readAsDataURL(file);
    }

    async function uploadToDrive(base64, filename) {
        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: "uploadImage", 
                    base64Data: base64, 
                    mimeType: "image/jpeg", 
                    fileName: filename 
                }) 
            });
            return await res.text();
        } catch(e) {
            alert("åœ–ç‰‡ä¸Šå‚³é›²ç«¯å¤±æ•—");
            return "";
        }
    }

    async function doBuy() {
        const id = document.getElementById('buyId').value;
        if(!id) { alert("è«‹è¼¸å…¥å•†å“ ID"); return; }
        
        showLoading(true, "æ­£åœ¨å…¥åº«...");
        const payload = { 
            action: "buy", 
            id: id, 
            name: document.getElementById('buyName').value, 
            cost: document.getElementById('buyCost').value, 
            price: document.getElementById('buyPrice').value, 
            supplier: document.getElementById('buySupplier').value, 
            img: document.getElementById('buyImg').value,
            certUrl: document.getElementById('buyCertUrl').value 
        };
        
        const res = await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        const text = await res.text(); // mode:no-cors å¯èƒ½æ‹¿ä¸åˆ° textï¼Œä½†æˆ‘å€‘å¯ä»¥å‡è¨­æˆåŠŸæˆ–æª¢æŸ¥ Stock
        
        // å›  no-cors ç„¡æ³•ç›´æ¥è®€å–å›æ‡‰ï¼Œæˆ‘å€‘æ‰‹å‹•æª¢æŸ¥é‡è¤‡ (å‰ç«¯ç°¡æ˜“åˆ¤æ–·) æˆ–ç›´æ¥é‡æ–°æ•´ç†
        alert("æ“ä½œå®Œæˆï¼(è‹¥ ID é‡è¤‡å°‡ä¸æœƒå…¥åº«)");
        
        showLoading(false);
        syncAll();
    }

    async function doSale() {
        const item = inventory.find(i => i[0] == document.getElementById('saleItem').value);
        await sendData({ action: "sale", id: item[0], name: item[1], customer: document.getElementById('saleClient').value, total: document.getElementById('saleFinalPrice').value, user: currentUser });
    }

    async function addContact() {
        await sendData({ action: "addContact", targetSheet: document.getElementById('contactType').value, id: document.getElementById('contactId').value, name: document.getElementById('contactName').value, phone: document.getElementById('contactPhone').value, note: document.getElementById('contactNote').value });
    }

    async function sendData(p) {
        showLoading(true);
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
        alert("æ“ä½œå®Œæˆï¼");
        syncAll();
    }

    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function showLoading(s, text="è¼‰å…¥ä¸­...") { 
        document.getElementById('loading').style.display = s ? 'flex' : 'none'; 
        document.getElementById('loadingText').innerText = text;
    }
</script>
</body>
</html>
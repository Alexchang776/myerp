<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼æ¥­ç´šERP-å…¨åŠŸèƒ½çµ‚æ¥µç‰ˆ</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --dark: #2c3e50; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        .header { background: var(--dark); color: white; padding: 20px 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; border-left: 5px solid var(--primary); padding-left: 10px; margin-bottom: 15px; font-size: 1.1rem; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; color: #555; }
        input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; color: white; font-size: 1rem; cursor: pointer; margin-bottom: 10px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; height: 70px; z-index: 100; }
        .nav-item { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; font-size: 0.7rem; color: #888; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 3000; font-weight: bold; color: var(--primary); }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; padding: 40px; box-sizing: border-box; }
        .stock-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #eee; }
        .list-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; }
        .is-staff .admin-only { display: none !important; }
        .badge { font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; color: #666; }
    </style>
</head>
<body id="mainBody">

<div id="loading">âŒ› é›²ç«¯è™•ç†ä¸­...</div>

<div id="loginOverlay">
    <h2 style="text-align:center;">ğŸ¬ ERP ç³»çµ±ç™»å…¥</h2>
    <input type="text" id="acc" placeholder="å¸³è™Ÿ">
    <input type="password" id="pwd" placeholder="å¯†ç¢¼">
    <button class="btn" style="background:var(--dark)" onclick="checkLogin()">ç™»å…¥</button>
</div>

<div class="header"><strong id="headerTitle">ä¼æ¥­ç®¡ç†ç³»çµ±</strong></div>

<div id="page-sale" class="page active">
    <div class="card">
        <h3>ğŸ’° éŠ·è²¨çµå¸³</h3>
        <label>é¸æ“‡å•†å“</label><select id="saleItem"></select>
        <label>é¸æ“‡å®¢æˆ¶</label><select id="saleClient"></select>
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="paymentMethod">
            <option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡</option><option>Line Pay</option><option>åŒ¯æ¬¾</option>
        </select>
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>æ•¸é‡</label><input type="number" id="saleQty" value="1"></div>
            <div style="flex:1" class="admin-only"><label>æŠ˜æ‰£</label><input type="number" id="saleDiscount" value="1" step="0.1"></div>
        </div>
        <button class="btn" style="background:var(--primary)" onclick="doSale()">ç¢ºèªçµå¸³</button>
    </div>
</div>

<div id="page-buy" class="page">
    <div class="card">
        <h3>ğŸ“¥ é€²è²¨å…¥åº«</h3>
        <label>ç”¢å“ç·¨è™Ÿ (ID)</label><input type="text" id="buyId" placeholder="ä¾‹å¦‚: P001">
        <label>å•†å“åç¨±</label><input type="text" id="buyName">
        <label>é¸æ“‡å» å•†</label><select id="buySupplier"></select>
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>æ•¸é‡</label><input type="number" id="buyQty"></div>
            <div style="flex:1"><label>å–®åƒ¹</label><input type="number" id="buyPrice"></div>
        </div>
        <button class="btn" style="background:#6c757d;" onclick="document.getElementById('cameraInput').click()">ğŸ“· æ‹æ”å•†å“åœ–</button>
        <input type="file" id="cameraInput" accept="image/*" style="display:none;" onchange="handleFileUpload(this)">
        <div id="imgPreview" style="text-align:center;"></div>
        <input type="hidden" id="buyImg">
        <button class="btn" style="background:var(--success)" onclick="doBuy()">å®Œæˆé€²è²¨</button>
    </div>
</div>

<div id="page-stock" class="page">
    <div class="card">
        <h3>ğŸ“¦ å³æ™‚åº«å­˜æ¸…å–®</h3>
        <div id="stockList"></div>
    </div>
</div>

<div id="page-contacts" class="page">
    <div class="card">
        <h3>ğŸ‘¥ å»ºç«‹åå–®è³‡æ–™</h3>
        <select id="contactType"><option value="Clients">å®¢æˆ¶</option><option value="Suppliers">å» å•†</option></select>
        <label>ç·¨è™Ÿ (ID)</label><input type="text" id="contactId" placeholder="ID">
        <label>åç¨±</label><input type="text" id="contactName">
        <label>é›»è©±/å‚™è¨»</label><input type="text" id="contactPhone">
        <button class="btn" style="background:var(--dark)" onclick="addContact()">å„²å­˜</button>
    </div>
    <div class="card">
        <h3>ğŸ“‹ åå–®åˆ—è¡¨ (å«ç´¯ç©æ¶ˆè²»)</h3>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button onclick="loadContacts('Clients')" style="flex:1">çœ‹å®¢æˆ¶</button>
            <button onclick="loadContacts('Suppliers')" style="flex:1">çœ‹å» å•†</button>
        </div>
        <div id="contactDisplay"></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showPage('sale', this)">ğŸ’°éŠ·è²¨</div>
    <div class="nav-item admin-only" id="nav-buy" onclick="showPage('buy', this)">ğŸ“¥é€²è²¨</div>
    <div class="nav-item" onclick="showPage('stock', this)">ğŸ“¦åº«å­˜</div>
    <div class="nav-item" onclick="showPage('contacts', this)">ğŸ‘¥åå–®</div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbymN7tFDVzZhi7HUanHBh9YKP07lgV1M4LrgNT7E5igPQU39KuGIIsxW-BWw4CMBPhcjA/exec"; 
    let inventory = [], clients = [], suppliers = [], currentUser = "", userRole = "";

    async function checkLogin() {
        const acc = document.getElementById('acc').value;
        const pwd = document.getElementById('pwd').value;
        showLoading(true);
        try {
            const r = await fetch(`${API_URL}?type=login&acc=${acc}&pwd=${pwd}`);
            const res = await r.json();
            if(res.status === "success") {
                currentUser = res.name; userRole = res.role;
                if(userRole === "staff") document.getElementById('mainBody').classList.add('is-staff');
                document.getElementById('loginOverlay').style.display = 'none';
                syncAll();
            } else { alert("å¸³å¯†éŒ¯èª¤"); }
        } catch(e) { alert("é€£ç·šå¤±æ•—"); }
        showLoading(false);
    }

    async function syncAll() {
        showLoading(true);
        const [stockRes, clientRes, suppRes] = await Promise.all([
            fetch(`${API_URL}?sheet=Stock`).then(r => r.json()),
            fetch(`${API_URL}?sheet=Clients`).then(r => r.json()),
            fetch(`${API_URL}?sheet=Suppliers`).then(r => r.json())
        ]);
        inventory = stockRes; clients = clientRes; suppliers = suppRes;
        renderAll();
        showLoading(false);
    }

    function renderAll() {
        document.getElementById('saleItem').innerHTML = inventory.map(i => `<option value="${i[0]}">[${i[0]}] ${i[1]} (å‰©${i[2]})</option>`).join('');
        document.getElementById('saleClient').innerHTML = clients.map(c => `<option value="${c[1]}">${c[1]}</option>`).join('');
        document.getElementById('buySupplier').innerHTML = suppliers.map(s => `<option value="${s[1]}">${s[1]}</option>`).join('');
        
        document.getElementById('stockList').innerHTML = inventory.map(i => `
            <div class="list-row">
                <img src="${i[5] || 'https://via.placeholder.com/60'}" class="stock-img">
                <div style="flex:1">
                    <span class="badge">#${i[0]}</span> <b>${i[1]}</b><br>
                    <small class="admin-only">æˆæœ¬: $${i[3]} | å» å•†: ${i[4]}</small>
                </div>
                <b>${i[2]}ä»¶</b>
            </div>
        `).join('');
    }

    function loadContacts(type) {
        const data = (type === 'Clients') ? clients : suppliers;
        document.getElementById('contactDisplay').innerHTML = data.map(d => `
            <div class="list-row">
                <div style="flex:1">
                    <span class="badge">${d[0]}</span> <b>${d[1]}</b><br>
                    <small>${d[2]}</small>
                </div>
                ${type === 'Clients' ? `<div style="color:var(--success); font-weight:bold;">$${d[4] || 0}</div>` : ''}
            </div>
        `).join('');
    }

    async function handleFileUpload(input) {
        const file = input.files[0]; if (!file) return;
        showLoading(true);
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = async function() {
                const canvas = document.createElement('canvas'); const maxWidth = 600;
                let width = img.width, height = img.height;
                if (width > maxWidth) { height = (height * maxWidth) / width; width = maxWidth; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                const base64Data = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "uploadImage", fileName: file.name, mimeType: "image/jpeg", base64Data: base64Data }) });
                const imageUrl = await res.text();
                document.getElementById('buyImg').value = imageUrl;
                document.getElementById('imgPreview').innerHTML = `<img src="${imageUrl}" style="width:100px; margin-top:10px; border-radius:8px;">`;
                showLoading(false);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function doSale() {
        const item = inventory.find(i => i[0] === document.getElementById('saleItem').value);
        const disc = userRole === "admin" ? document.getElementById('saleDiscount').value : 1;
        const total = item[3] * document.getElementById('saleQty').value * disc;
        const payload = {
            action: "sale", id: item[0], name: item[1], qty: document.getElementById('saleQty').value,
            customer: document.getElementById('saleClient').value, payment: document.getElementById('paymentMethod').value,
            total: total, user: currentUser
        };
        await sendData(payload);
    }

    async function doBuy() {
        const payload = {
            action: "buy", id: document.getElementById('buyId').value, name: document.getElementById('buyName').value,
            qty: document.getElementById('buyQty').value, price: document.getElementById('buyPrice').value,
            supplier: document.getElementById('buySupplier').value, img: document.getElementById('buyImg').value
        };
        await sendData(payload);
    }

    async function addContact() {
        const payload = {
            action: "addContact", targetSheet: document.getElementById('contactType').value,
            rowData: [document.getElementById('contactId').value, document.getElementById('contactName').value, document.getElementById('contactPhone').value]
        };
        await sendData(payload);
    }

    async function sendData(p) {
        showLoading(true);
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(p) });
        alert("åŒæ­¥æˆåŠŸ");
        setTimeout(syncAll, 1500);
    }

    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
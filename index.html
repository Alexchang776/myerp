<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å…¬å¸é›²ç«¯ERP">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180?text=ERP">
    
    <title>ä¼æ¥­å…¨æ–¹ä½é›²ç«¯ç®¡ç†ç³»çµ±</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #ffc107; --danger: #dc3545; --dark: #2c3e50; --light: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f0f2f5; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* ç™»å…¥é®ç½© */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; padding: 40px; box-sizing: border-box; }
        
        .header { background: var(--dark); color: white; padding: 20px 15px 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; color: var(--dark); border-left: 5px solid var(--primary); padding-left: 10px; margin-bottom: 20px; font-size: 1.1rem; }
        
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; color: #555; }
        input, select { width: 100%; padding: 12px; margin-bottom: 18px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; -webkit-appearance: none; }
        
        .btn { width: 100%; padding: 16px; border-radius: 10px; border: none; font-weight: bold; color: white; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f1f1f1; }
        .item-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; }
        .status-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 5px; font-weight: bold; }

        /* å°è¦½åˆ— */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; height: 70px; box-shadow: 0 -2px 15px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; font-size: 0.75rem; color: #888; text-decoration: none; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; margin-bottom: 3px; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 3000; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="loading">âŒ› é›²ç«¯åŒæ­¥ä¸­...</div>

<div id="loginOverlay">
    <h1 style="text-align:center; color:var(--dark);">ğŸ¢ ä¼æ¥­ç³»çµ±ç™»å…¥</h1>
    <p style="text-align:center; color:#888; margin-bottom:30px;">è«‹è¼¸å…¥å“¡å·¥å¸³è™Ÿå¯†ç¢¼</p>
    <label>å¸³è™Ÿ</label>
    <input type="text" id="acc" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
    <label>å¯†ç¢¼</label>
    <input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="btn" style="background:var(--dark)" onclick="checkLogin()">ç«‹å³ç™»å…¥</button>
</div>

<div class="header"><strong id="headerTitle">æ•¸ä½ä¼æ¥­ç®¡ç†ç³»çµ±</strong></div>

<div id="page-sale" class="page active">
    <div class="card">
        <h3>ğŸ’° éŠ·è²¨çµå¸³</h3>
        <label>é¸æ“‡å•†å“</label><select id="saleItem"></select>
        <label>å®¢æˆ¶åç¨±</label><input type="text" id="saleCustomer" placeholder="é è¨­ï¼šä¸€èˆ¬æ•£å®¢">
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="paymentMethod">
            <option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡</option><option>Line Pay</option><option>å°ç£Pay</option><option>åŒ¯æ¬¾</option>
        </select>
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>æ•¸é‡</label><input type="number" id="saleQty" value="1"></div>
            <div style="flex:1"><label>æŠ˜æ‰£ (1=åŸåƒ¹)</label><input type="number" id="saleDiscount" value="1" step="0.1"></div>
        </div>
        <button class="btn" style="background:var(--primary)" onclick="doSale()">ç¢ºèªå‡ºè²¨</button>
    </div>
</div>

<div id="page-add" class="page">
    <div class="card">
        <h3>ğŸ“¥ é€²è²¨å…¥åº«</h3>
        <label>å•†å“åç¨±</label><input type="text" id="buyName" placeholder="ä¾‹å¦‚ï¼šç„¡ç·šé¼ æ¨™">
        <label>ä¾›æ‡‰å» å•†</label><input type="text" id="buySupplier" placeholder="ä¾†æºå» å•†åç¨±">
        <label>åœ–ç‰‡ç¶²å€</label><input type="text" id="buyImg" placeholder="https://...">
        <div style="display:flex; gap:10px">
            <div style="flex:1"><label>æ•¸é‡</label><input type="number" id="buyQty"></div>
            <div style="flex:1"><label>æ¡è³¼å–®åƒ¹</label><input type="number" id="buyPrice"></div>
        </div>
        <button class="btn" style="background:var(--success)" onclick="doBuy()">å®Œæˆé€²è²¨</button>
    </div>
</div>

<div id="page-stock" class="page">
    <div class="card">
        <h3>ğŸ“¦ é›²ç«¯å³æ™‚åº«å­˜</h3>
        <button onclick="syncFromCloud()" style="margin-bottom:15px; padding:8px; font-size:0.8rem; background:#eee; border:none; border-radius:5px;">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
        <div id="stockList"></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="showPage('sale', this)"><div class="nav-icon">ğŸ’°</div>éŠ·è²¨</div>
    <div class="nav-item" onclick="showPage('add', this)"><div class="nav-icon">ğŸ“¥</div>é€²è²¨</div>
    <div class="nav-item" onclick="showPage('stock', this)"><div class="nav-icon">ğŸ“¦</div>åº«å­˜</div>
</div>

<script>
    // --------------------------------------------------
    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ Google Apps Script URL âš ï¸
    const API_URL = "https://script.google.com/macros/s/AKfycbymN7tFDVzZhi7HUanHBh9YKP07lgV1M4LrgNT7E5igPQU39KuGIIsxW-BWw4CMBPhcjA/exec";
    // --------------------------------------------------

    let inventory = [];
    let currentUser = "";

    // ç™»å…¥é©—è­‰
    async function checkLogin() {
        const acc = document.getElementById('acc').value;
        const pwd = document.getElementById('pwd').value;
        if(!acc || !pwd) return alert("è«‹è¼¸å…¥å¸³å¯†");
        
        showLoading(true);
        try {
            const resp = await fetch(`${API_URL}?type=login&acc=${acc}&pwd=${pwd}`);
            const result = await resp.json();
            if (result.status === "success") {
                currentUser = result.name;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('headerTitle').innerText = "æ­¡è¿ï¼Œ" + currentUser;
                syncFromCloud();
            } else {
                alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        } catch (e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API ç¶²å€"); }
        showLoading(false);
    }

    // åŒæ­¥é›²ç«¯åº«å­˜
    async function syncFromCloud() {
        showLoading(true);
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            inventory = data.map(row => ({
                name: row[0], qty: row[1], price: row[2], supplier: row[3], img: row[4]
            }));
            render();
        } catch (e) { console.error("åŒæ­¥å¤±æ•—"); }
        showLoading(false);
    }

    function render() {
        // æ›´æ–°éŠ·è²¨ä¸‹æ‹‰é¸å–®
        const saleSelect = document.getElementById('saleItem');
        saleSelect.innerHTML = inventory.map(i => `<option value="${i.name}">${i.name} (å‰©:${i.qty})</option>`).join('');

        // æ›´æ–°åº«å­˜åˆ—è¡¨
        const stockList = document.getElementById('stockList');
        stockList.innerHTML = inventory.map(i => `
            <div class="list-item">
                <img src="${i.img || 'https://via.placeholder.com/50'}" class="item-img">
                <div style="flex:1"><b>${i.name}</b><br><small>å–®åƒ¹: $${i.price} | å» å•†: ${i.supplier || 'ç„¡'}</small></div>
                <div style="text-align:right">
                    <b style="color:${i.qty <= 5 ? 'red' : 'inherit'}">${i.qty}</b><br>
                    <span class="status-tag" style="background:${i.qty <= 5 ? '#ffebee' : '#e8f5e9'}">${i.qty <= 5 ? 'è£œè²¨' : 'å……è¶³'}</span>
                </div>
            </div>
        `).join('') || '<p style="text-align:center; color:#999;">é›²ç«¯å°šç„¡è³‡æ–™</p>';
    }

    // åŸ·è¡Œé€²è²¨
    async function doBuy() {
        const payload = {
            action: "buy",
            name: document.getElementById('buyName').value,
            qty: parseInt(document.getElementById('buyQty').value),
            price: parseFloat(document.getElementById('buyPrice').value),
            supplier: document.getElementById('buySupplier').value,
            img: document.getElementById('buyImg').value
        };

        if(!payload.name || isNaN(payload.qty)) return alert("è«‹å¡«å¯«å¿…è¦é€²è²¨è³‡è¨Š");
        
        showLoading(true);
        try {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("é€²è²¨æˆåŠŸï¼é›²ç«¯å·²æ›´æ–°");
            document.getElementById('buyName').value = '';
            document.getElementById('buyQty').value = '';
            setTimeout(syncFromCloud, 1000);
        } catch (e) { alert("å‚³é€å¤±æ•—"); }
        showLoading(false);
    }

    // åŸ·è¡ŒéŠ·è²¨
    async function doSale() {
        const name = document.getElementById('saleItem').value;
        const qty = parseInt(document.getElementById('saleQty').value);
        const discount = parseFloat(document.getElementById('saleDiscount').value);
        const item = inventory.find(i => i.name === name);

        if (!item || item.qty < qty) return alert("åº«å­˜ä¸è¶³ï¼");

        const payload = {
            action: "sale",
            name: name,
            qty: qty,
            customer: document.getElementById('saleCustomer').value || "ä¸€èˆ¬æ•£å®¢",
            payment: document.getElementById('paymentMethod').value,
            total: item.price * qty * discount,
            user: currentUser
        };

        showLoading(true);
        try {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("çµå¸³å®Œæˆï¼");
            setTimeout(syncFromCloud, 1000);
        } catch (e) { alert("å‚³é€å¤±æ•—"); }
        showLoading(false);
    }

    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }
</script>
</body>
</html>